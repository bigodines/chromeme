<!-- <script language="JavaScript" src="smart_meme.js"></script> -->
<script>

chrome.browserAction.onClicked.addListener(function(tab) {
    chrome.tabs.executeScript(null,
                           {file:"content_script.js",
                            allFrames: true}
                           );
   // attempt to fix smart_meme is not defined bug.
   chrome.tabs.executeScript(null,
                           {file:"smart_meme.js",
                            allFrames: true}
                           );
    chrome.browserAction.setPopup({popup:"popup.html"});
});

// TODO REFACTOR THESE FUNCTIONS!!
function clear() {
    chrome.tabs.getSelected(null, function(tab) {
        chrome.tabs.sendRequest(tab.id, {cmd: "clear"});
    });
}
function post() {
    chrome.tabs.getSelected(null, function(tab) {
        chrome.tabs.sendRequest(tab.id, {cmd: "post"}, function(response) {
          if (!response.url) return false;
          try {
              makeRequest(response.url, response.data);
	  } catch (e) {
	      alert(e);
	  }
        });
    });
}

/**
    ajax galponero
*/
var makeRequest = function(url, data /*, method = 'POST' */) { 
    var req = new XMLHttpRequest();
    req.open('POST', url, true);
    req.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

    req.send(data);

    req.onreadystatechange = function(evt) { 
	if (req.readyState === 4) {
	    if (req.status === 200) {
                chrome.tabs.create({'url':url, 'selected': true});
                console.log(req.responseText);
                //sendResponse({url:url});
	    } else {
		alert(2);// fuuuuu
	    }
	}
    };
};

</script>